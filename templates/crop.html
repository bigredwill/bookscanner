<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Image Cropping - Book Scanner</title>
        <link rel="stylesheet" href="/static/css/style.css" />
        <style>
            .crop-container {
                display: flex;
                gap: 20px;
                margin: 20px;
            }

            .crop-controls {
                width: 300px;
                padding: 20px;
                background: #f5f5f5;
                border-radius: 8px;
            }

            .crop-preview {
                flex: 1;
                position: relative;
            }

            .image-canvas-container {
                position: relative;
                display: inline-block;
                max-width: 100%;
            }

            #preview-image {
                max-width: 100%;
                height: auto;
                display: block;
            }

            #crop-overlay {
                position: absolute;
                top: 0;
                left: 0;
                cursor: move;
            }

            .control-group {
                margin: 15px 0;
            }

            .control-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }

            .control-group input {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }

            .control-group input[type="range"] {
                width: calc(100% - 60px);
            }

            .range-value {
                display: inline-block;
                width: 50px;
                text-align: right;
                font-family: monospace;
            }

            .btn {
                padding: 10px 20px;
                margin: 5px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
            }

            .btn-primary {
                background: #007bff;
                color: white;
            }

            .btn-success {
                background: #28a745;
                color: white;
            }

            .btn-warning {
                background: #ffc107;
                color: black;
            }

            .btn-secondary {
                background: #6c757d;
                color: white;
            }

            .btn:hover {
                opacity: 0.9;
            }

            .image-selector {
                margin: 15px 0;
            }

            .image-selector select {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }

            .status-message {
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
            }

            .status-success {
                background: #d4edda;
                color: #155724;
            }

            .status-error {
                background: #f8d7da;
                color: #721c24;
            }

            .crop-rect {
                border: 3px solid red;
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
                position: absolute;
            }

            .resize-handle {
                width: 10px;
                height: 10px;
                background: red;
                position: absolute;
                border: 1px solid white;
            }

            .handle-nw {
                top: -5px;
                left: -5px;
                cursor: nw-resize;
            }
            .handle-ne {
                top: -5px;
                right: -5px;
                cursor: ne-resize;
            }
            .handle-sw {
                bottom: -5px;
                left: -5px;
                cursor: sw-resize;
            }
            .handle-se {
                bottom: -5px;
                right: -5px;
                cursor: se-resize;
            }
            .handle-n {
                top: -5px;
                left: 50%;
                margin-left: -5px;
                cursor: n-resize;
            }
            .handle-s {
                bottom: -5px;
                left: 50%;
                margin-left: -5px;
                cursor: s-resize;
            }
            .handle-w {
                top: 50%;
                left: -5px;
                margin-top: -5px;
                cursor: w-resize;
            }
            .handle-e {
                top: 50%;
                right: -5px;
                margin-top: -5px;
                cursor: e-resize;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="title">Image Cropping</div>
            <div style="margin: 10px 0">
                <a href="/" class="btn btn-secondary">‚Üê Back to Scanner</a>
            </div>
        </div>

        <div class="crop-container">
            <div class="crop-controls">
                <h3>Crop Settings</h3>

                <div class="image-selector">
                    <label for="session-select">Select Session:</label>
                    <select id="session-select" onchange="loadSessionImages()">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <div class="image-selector">
                    <label for="image-select">Select Image:</label>
                    <select id="image-select" onchange="loadImage()">
                        <option value="">Select session first...</option>
                    </select>
                </div>

                <div id="status-message"></div>

                <div class="control-group">
                    <label
                        >Left:
                        <span class="range-value" id="left-value"
                            >0</span
                        ></label
                    >
                    <input
                        type="range"
                        id="left-slider"
                        min="0"
                        max="1000"
                        value="0"
                        oninput="updateCropFromSliders()"
                    />
                </div>

                <div class="control-group">
                    <label
                        >Top:
                        <span class="range-value" id="top-value">0</span></label
                    >
                    <input
                        type="range"
                        id="top-slider"
                        min="0"
                        max="1000"
                        value="0"
                        oninput="updateCropFromSliders()"
                    />
                </div>

                <div class="control-group">
                    <label
                        >Right:
                        <span class="range-value" id="right-value"
                            >1000</span
                        ></label
                    >
                    <input
                        type="range"
                        id="right-slider"
                        min="0"
                        max="1000"
                        value="1000"
                        oninput="updateCropFromSliders()"
                    />
                </div>

                <div class="control-group">
                    <label
                        >Bottom:
                        <span class="range-value" id="bottom-value"
                            >1000</span
                        ></label
                    >
                    <input
                        type="range"
                        id="bottom-slider"
                        min="0"
                        max="1000"
                        value="1000"
                        oninput="updateCropFromSliders()"
                    />
                </div>

                <div class="control-group">
                    <button
                        class="btn btn-primary"
                        onclick="saveCropSettings()"
                    >
                        üíæ Save Settings
                    </button>
                    <button
                        class="btn btn-secondary"
                        onclick="loadCropSettings()"
                    >
                        üìÇ Load Settings
                    </button>
                </div>

                <div class="control-group">
                    <button class="btn btn-success" onclick="applyCropToAll()">
                        ‚úÇÔ∏è Apply to All Images
                    </button>
                </div>

                <div class="control-group">
                    <h4>Crop Dimensions</h4>
                    <div id="crop-dimensions">
                        Width: <span id="crop-width">-</span>px<br />
                        Height: <span id="crop-height">-</span>px
                    </div>
                </div>
            </div>

            <div class="crop-preview">
                <h3>Preview</h3>
                <div class="image-canvas-container">
                    <img
                        id="preview-image"
                        src=""
                        alt="Select an image to preview"
                    />
                    <div id="crop-rect" class="crop-rect" style="display: none">
                        <div class="resize-handle handle-nw"></div>
                        <div class="resize-handle handle-n"></div>
                        <div class="resize-handle handle-ne"></div>
                        <div class="resize-handle handle-w"></div>
                        <div class="resize-handle handle-e"></div>
                        <div class="resize-handle handle-sw"></div>
                        <div class="resize-handle handle-s"></div>
                        <div class="resize-handle handle-se"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let currentImage = null;
            let currentSession = null;
            let imageWidth = 0;
            let imageHeight = 0;
            let cropSettings = { left: 0, top: 0, right: 0, bottom: 0 };
            let isDragging = false;
            let dragStartX = 0;
            let dragStartY = 0;
            let dragStartCrop = {};
            let resizeHandle = null;

            // Load list of sessions
            async function loadSessionList() {
                try {
                    const response = await fetch("/api/sessions");
                    const data = await response.json();
                    const select = document.getElementById("session-select");
                    select.innerHTML = "";

                    if (data.sessions && data.sessions.length > 0) {
                        data.sessions.forEach((session) => {
                            const option = document.createElement("option");
                            option.value = session.session_name;
                            const label = session.is_current
                                ? " (current)"
                                : "";
                            option.textContent = `${session.session_name} (${session.image_count} images)${label}`;
                            select.appendChild(option);
                        });
                        // Auto-select current session if available
                        const currentSessionData = data.sessions.find(
                            (s) => s.is_current,
                        );
                        if (currentSessionData) {
                            select.value = currentSessionData.session_name;
                        }
                        loadSessionImages();
                    } else {
                        select.innerHTML =
                            '<option value="">No sessions found</option>';
                    }
                } catch (error) {
                    console.error("Error loading sessions:", error);
                    showStatus("Error loading sessions: " + error, "error");
                }
            }

            // Load images for selected session
            async function loadSessionImages() {
                const sessionSelect = document.getElementById("session-select");
                currentSession = sessionSelect.value;

                if (!currentSession) {
                    return;
                }

                try {
                    const response = await fetch(
                        `/api/session/${currentSession}/images`,
                    );
                    const data = await response.json();
                    const select = document.getElementById("image-select");
                    select.innerHTML = "";

                    if (data.images && data.images.length > 0) {
                        data.images.forEach((img) => {
                            const option = document.createElement("option");
                            option.value = img.filename;
                            option.textContent = `${img.filename} (${img.megapixels})`;
                            select.appendChild(option);
                        });
                        loadImage();
                        loadCropSettings();
                    } else {
                        select.innerHTML =
                            '<option value="">No images found</option>';
                    }
                } catch (error) {
                    console.error("Error loading images:", error);
                    showStatus("Error loading images: " + error, "error");
                }
            }

            // Load selected image
            function loadImage() {
                const select = document.getElementById("image-select");
                currentImage = select.value;

                if (!currentImage) return;

                const img = document.getElementById("preview-image");
                // Use session-specific image path
                if (currentSession) {
                    img.src = `/img/${currentSession}/${currentImage}`;
                } else {
                    img.src = "/img/" + currentImage;
                }

                img.onload = function () {
                    // Get natural image dimensions
                    imageWidth = img.naturalWidth;
                    imageHeight = img.naturalHeight;

                    // Update slider ranges
                    document.getElementById("left-slider").max = imageWidth;
                    document.getElementById("top-slider").max = imageHeight;
                    document.getElementById("right-slider").max = imageWidth;
                    document.getElementById("bottom-slider").max = imageHeight;

                    // Initialize crop to full image if not set
                    if (cropSettings.right === 0 || cropSettings.bottom === 0) {
                        cropSettings = {
                            left: 0,
                            top: 0,
                            right: imageWidth,
                            bottom: imageHeight,
                        };
                    }

                    updateSlidersFromCrop();
                    updateCropOverlay();
                };
            }

            // Update crop overlay on image
            function updateCropOverlay() {
                const img = document.getElementById("preview-image");
                const rect = document.getElementById("crop-rect");

                if (!img.complete) return;

                const scaleX = img.width / imageWidth;
                const scaleY = img.height / imageHeight;

                const left = cropSettings.left * scaleX;
                const top = cropSettings.top * scaleY;
                const width = (cropSettings.right - cropSettings.left) * scaleX;
                const height =
                    (cropSettings.bottom - cropSettings.top) * scaleY;

                rect.style.left = left + "px";
                rect.style.top = top + "px";
                rect.style.width = width + "px";
                rect.style.height = height + "px";
                rect.style.display = "block";

                // Update dimensions display
                document.getElementById("crop-width").textContent = Math.round(
                    cropSettings.right - cropSettings.left,
                );
                document.getElementById("crop-height").textContent = Math.round(
                    cropSettings.bottom - cropSettings.top,
                );
            }

            // Update sliders from crop settings
            function updateSlidersFromCrop() {
                document.getElementById("left-slider").value =
                    cropSettings.left;
                document.getElementById("top-slider").value = cropSettings.top;
                document.getElementById("right-slider").value =
                    cropSettings.right;
                document.getElementById("bottom-slider").value =
                    cropSettings.bottom;

                document.getElementById("left-value").textContent = Math.round(
                    cropSettings.left,
                );
                document.getElementById("top-value").textContent = Math.round(
                    cropSettings.top,
                );
                document.getElementById("right-value").textContent = Math.round(
                    cropSettings.right,
                );
                document.getElementById("bottom-value").textContent =
                    Math.round(cropSettings.bottom);
            }

            // Update crop from sliders
            function updateCropFromSliders() {
                cropSettings.left = parseInt(
                    document.getElementById("left-slider").value,
                );
                cropSettings.top = parseInt(
                    document.getElementById("top-slider").value,
                );
                cropSettings.right = parseInt(
                    document.getElementById("right-slider").value,
                );
                cropSettings.bottom = parseInt(
                    document.getElementById("bottom-slider").value,
                );

                updateSlidersFromCrop();
                updateCropOverlay();
            }

            // Save crop settings
            async function saveCropSettings() {
                try {
                    const url = currentSession
                        ? `/api/crop-settings?session=${currentSession}`
                        : "/api/crop-settings";

                    const response = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(cropSettings),
                    });
                    const data = await response.json();

                    if (data.status === "ok") {
                        showStatus("Crop settings saved!", "success");
                    } else {
                        showStatus("Error: " + data.message, "error");
                    }
                } catch (error) {
                    showStatus("Error saving settings: " + error, "error");
                }
            }

            // Load crop settings
            async function loadCropSettings() {
                try {
                    const url = currentSession
                        ? `/api/crop-settings?session=${currentSession}`
                        : "/api/crop-settings";

                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.left !== undefined) {
                        cropSettings = data;
                        updateSlidersFromCrop();
                        updateCropOverlay();
                        showStatus("Crop settings loaded!", "success");
                    } else {
                        showStatus("No saved crop settings found", "error");
                    }
                } catch (error) {
                    showStatus("Error loading settings: " + error, "error");
                }
            }

            // Apply crop to all images
            async function applyCropToAll() {
                if (
                    !confirm(
                        'Apply this crop to all images? This will create cropped versions in the "cropped" folder.',
                    )
                ) {
                    return;
                }

                showStatus("Cropping all images, please wait...", "success");

                try {
                    const payload = { crop: cropSettings };
                    if (currentSession) {
                        payload.session = currentSession;
                    }

                    const response = await fetch("/api/apply-crop", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload),
                    });
                    const data = await response.json();

                    if (data.status === "ok") {
                        showStatus(
                            data.message + "! Output: " + data.output_dir,
                            "success",
                        );
                    } else {
                        showStatus("Error: " + data.message, "error");
                    }
                } catch (error) {
                    showStatus("Error applying crop: " + error, "error");
                }
            }

            // Show status message
            function showStatus(message, type) {
                const statusDiv = document.getElementById("status-message");
                statusDiv.className = "status-message status-" + type;
                statusDiv.textContent = message;

                if (type === "success") {
                    setTimeout(() => {
                        statusDiv.textContent = "";
                        statusDiv.className = "status-message";
                    }, 5000);
                }
            }

            // Drag and resize handlers
            const cropRect = document.getElementById("crop-rect");

            cropRect.addEventListener("mousedown", function (e) {
                if (e.target.classList.contains("resize-handle")) {
                    resizeHandle = e.target;
                } else {
                    resizeHandle = null;
                }

                isDragging = true;
                const img = document.getElementById("preview-image");
                const rect = img.getBoundingClientRect();

                dragStartX = e.clientX;
                dragStartY = e.clientY;
                dragStartCrop = { ...cropSettings };

                e.preventDefault();
            });

            document.addEventListener("mousemove", function (e) {
                if (!isDragging) return;

                const img = document.getElementById("preview-image");
                const scaleX = imageWidth / img.width;
                const scaleY = imageHeight / img.height;

                const deltaX = (e.clientX - dragStartX) * scaleX;
                const deltaY = (e.clientY - dragStartY) * scaleY;

                if (resizeHandle) {
                    // Resize
                    const classes = resizeHandle.className;

                    if (
                        classes.includes("handle-w") ||
                        classes.includes("handle-nw") ||
                        classes.includes("handle-sw")
                    ) {
                        cropSettings.left = Math.max(
                            0,
                            Math.min(
                                dragStartCrop.right - 100,
                                dragStartCrop.left + deltaX,
                            ),
                        );
                    }
                    if (
                        classes.includes("handle-e") ||
                        classes.includes("handle-ne") ||
                        classes.includes("handle-se")
                    ) {
                        cropSettings.right = Math.min(
                            imageWidth,
                            Math.max(
                                dragStartCrop.left + 100,
                                dragStartCrop.right + deltaX,
                            ),
                        );
                    }
                    if (
                        classes.includes("handle-n") ||
                        classes.includes("handle-nw") ||
                        classes.includes("handle-ne")
                    ) {
                        cropSettings.top = Math.max(
                            0,
                            Math.min(
                                dragStartCrop.bottom - 100,
                                dragStartCrop.top + deltaY,
                            ),
                        );
                    }
                    if (
                        classes.includes("handle-s") ||
                        classes.includes("handle-sw") ||
                        classes.includes("handle-se")
                    ) {
                        cropSettings.bottom = Math.min(
                            imageHeight,
                            Math.max(
                                dragStartCrop.top + 100,
                                dragStartCrop.bottom + deltaY,
                            ),
                        );
                    }
                } else {
                    // Move
                    const width = dragStartCrop.right - dragStartCrop.left;
                    const height = dragStartCrop.bottom - dragStartCrop.top;

                    let newLeft = dragStartCrop.left + deltaX;
                    let newTop = dragStartCrop.top + deltaY;

                    // Constrain to image bounds
                    newLeft = Math.max(
                        0,
                        Math.min(imageWidth - width, newLeft),
                    );
                    newTop = Math.max(
                        0,
                        Math.min(imageHeight - height, newTop),
                    );

                    cropSettings.left = newLeft;
                    cropSettings.top = newTop;
                    cropSettings.right = newLeft + width;
                    cropSettings.bottom = newTop + height;
                }

                updateSlidersFromCrop();
                updateCropOverlay();
            });

            document.addEventListener("mouseup", function () {
                isDragging = false;
                resizeHandle = null;
            });

            // Auto-load crop settings on startup
            window.addEventListener("load", function () {
                loadSessionList();
            });
        </script>
    </body>
</html>
